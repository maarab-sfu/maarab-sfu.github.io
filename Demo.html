<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ImageShield Demo</title>
</head>
<body>

<h2>1. Protect Image (Embedding)</h2>

<input type="file" id="embedInput" accept="image/*">
<br><br>
<button id="embedBtn" onclick="runEmbed()">Protect Image</button>

<br><br>
<h4>Input Image</h4>
<img id="embedPreview" width="256">

<br><br>
<h4>Protected Image</h4>
<img id="protectedImage" width="256">

<br><br>
<a id="downloadProtected" download style="display:none;">
  Download Protected Image
</a>

<hr>

<h2>2. Detect & Restore (Extraction)</h2>

<input type="file" id="extractInput" accept="image/*">
<br><br>
<button id="extractBtn" onclick="runExtract()">Run Extraction</button>

<br><br>
<h4>Input (Protected / Tampered)</h4>
<img id="extractPreview" width="256">

<br><br>
<h4>Restored Image</h4>
<img id="restoredImage" width="256">

<h4>Localization Mask</h4>
<img id="maskImage" width="256">

<script>
const API_BASE = "http://13.220.125.117:8000";

/* ---------- Utilities ---------- */

function previewImage(input, imgElement) {
  const file = input.files[0];
  if (!file) return;
  imgElement.src = URL.createObjectURL(file);
}

function clearExtractionOutputs() {
  document.getElementById("restoredImage").src = "";
  document.getElementById("maskImage").src = "";
}

/* ---------- Input previews ---------- */

document.getElementById("embedInput").addEventListener("change", () => {
  previewImage(
    document.getElementById("embedInput"),
    document.getElementById("embedPreview")
  );
  document.getElementById("protectedImage").src = "";
  document.getElementById("downloadProtected").style.display = "none";
});

document.getElementById("extractInput").addEventListener("change", () => {
  previewImage(
    document.getElementById("extractInput"),
    document.getElementById("extractPreview")
  );
  clearExtractionOutputs();
});

/* ---------- Embed ---------- */

async function runEmbed() {
  const btn = document.getElementById("embedBtn");
  const fileInput = document.getElementById("embedInput");

  if (!fileInput.files.length) {
    alert("Please select an image.");
    return;
  }

  btn.disabled = true;

  const formData = new FormData();
  formData.append("file", fileInput.files[0]);

  try {
    const res = await fetch(`${API_BASE}/embed`, {
      method: "POST",
      body: formData
    });

    const data = await res.json();

    if (!res.ok || !data.success) {
      throw new Error(data.detail || "Embedding failed");
    }

    const imgUrl = API_BASE + data.protected_image;

    document.getElementById("protectedImage").src = imgUrl;

    const dl = document.getElementById("downloadProtected");
    dl.href = imgUrl;
    dl.style.display = "inline";

  } catch (err) {
    alert(err.message);
  } finally {
    btn.disabled = false;
  }
}

/* ---------- Extract ---------- */

async function runExtract() {
  const btn = document.getElementById("extractBtn");
  const fileInput = document.getElementById("extractInput");

  if (!fileInput.files.length) {
    alert("Please select an image.");
    return;
  }

  btn.disabled = true;
  clearExtractionOutputs();

  const formData = new FormData();
  formData.append("file", fileInput.files[0]);

  try {
    const res = await fetch(`${API_BASE}/extract`, {
      method: "POST",
      body: formData
    });

    const data = await res.json();

    if (!res.ok || !data.success) {
      throw new Error(data.detail || "Extraction failed");
    }

    document.getElementById("restoredImage").src =
      API_BASE + data.restored_image;

    document.getElementById("maskImage").src =
      API_BASE + data.localization_mask;

  } catch (err) {
    alert(err.message);
  } finally {
    btn.disabled = false;
  }
}
</script>

</body>
</html>
